<!DOCTYPE html>
<html lang="en"><head>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-html/tabby.min.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.8.25">

  <meta name="author" content="Jordi Mateo Fornés">
  <title>SO - Fall 2025 – Creació de Processos a Linux</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="../site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="../site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../site_libs/revealjs/dist/theme/quarto-534cd8e3a96973385dffff3f4709048d.css">
  <link rel="stylesheet" href="styles.css">
  <link href="../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
  <script src="../site_libs/quarto-diagram/mermaid.min.js"></script>
  <script src="../site_libs/quarto-diagram/mermaid-init.js"></script>
  <link href="../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">Creació de Processos a Linux</h1>
  <p class="subtitle">Unitat 3 · Sistemes Operatius (SO)</p>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
Jordi Mateo Fornés 
</div>
</div>
</div>

</section>
<section id="mecanisme-de-creació-fork" class="slide level2 smaller">
<h2>Mecanisme de Creació <code>fork()</code></h2>
<div class="columns">
<div class="column" style="width:45%;">
<p><code>fork()</code> crea una <strong>còpia exacta</strong> del procés actual (<em>el pare</em>). Aquesta còpia esdevé el procés <em>fill</em> i s’executa <strong>independentment</strong> i <strong>simultàniament</strong>.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb1-1"><a aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span><span class="pp"> # pid_t</span></span>
<span id="cb1-2"><a aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span><span class="pp">    # fork()</span></span>
<span id="cb1-3"><a aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-4"><a aria-hidden="true" tabindex="-1"></a>    pid_t pid <span class="op">=</span> fork<span class="op">();</span></span>
<span id="cb1-5"><a aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb1-6"><a aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div title="Espai de Memòria">
<div class="callout callout-warning callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Espai de Memòria</strong></p>
</div>
<div class="callout-content">
<p>Els processos <strong>pare (A)</strong> i <strong>fill (B)</strong> <em>no comparteixen espai de memòria</em>. Cada procés té el seu propi espai d’adreces virtuals. No obstant això, el contingut inicial de la memòria del procés pare es copia a l’espai d’adreces del fill.</p>
</div>
</div>
</div>
</div>
</div><div class="column" style="width:55%;">
<p><img data-src="../figures/slides/03-create/fork_1.png"></p>
</div></div>
</section>
<section id="jerarquia-de-processos-fork" class="slide level2 smaller">
<h2>Jerarquia de Processos · <code>fork()</code></h2>
<h4 id="ex1.c">ex1.c</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb2-1"><a aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb2-2"><a aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb2-3"><a aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb2-4"><a aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-5"><a aria-hidden="true" tabindex="-1"></a>    pid_t pid<span class="op">;</span></span>
<span id="cb2-6"><a aria-hidden="true" tabindex="-1"></a>    pid <span class="op">=</span> fork<span class="op">();</span></span>
<span id="cb2-7"><a aria-hidden="true" tabindex="-1"></a>    sleep<span class="op">(</span><span class="dv">20</span><span class="op">);</span></span>
<span id="cb2-8"><a aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb2-9"><a aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><br></p>
<h4 id="terminal-a">Terminal A</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a aria-hidden="true" tabindex="-1"></a><span class="ex">watch</span> <span class="at">-n</span> 1 <span class="st">"ps -ef | grep bash | grep -v grep"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><br></p>
<h4 id="terminal-b">Terminal B</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$$</span> <span class="kw">&amp;&amp;</span> <span class="fu">gcc</span> ex1.c <span class="at">-o</span> ex1 <span class="kw">&amp;&amp;</span> <span class="ex">./ex1</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="execució-independentfork" class="slide level2 smaller">
<h2>Execució Independent:<code>fork()</code></h2>
<div class="columns">
<div class="column" style="width:50%;">
<div title="Valors de retorn: ```fork()```">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Valors de retorn: <code>fork()</code></strong></p>
</div>
<div class="callout-content">
<ul>
<li>Si <code>fork()</code> té èxit:
<ul>
<li>Retorna un valor <span class="math inline">\(&gt;0\)</span> al procés <strong>pare</strong> (<em>el PID del procés fill</em>).</li>
<li>Retorna <strong>0</strong> al procés <strong>fill</strong>.</li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>
<div title="Consideracions">
<div class="callout callout-caution callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Consideracions</strong></p>
</div>
<div class="callout-content">
<ul>
<li>Si <code>fork()</code> falla en el procés <strong>pare</strong>, retorna un valor <span class="math inline">\(&lt;0\)</span> i el codi d’error es guarda a la variable <em>errno</em>.</li>
<li>Si <code>fork()</code> falla, no es crea cap <strong>procés fill</strong>.</li>
</ul>
</div>
</div>
</div>
</div>
<div title="Observacions">
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Observacions</strong></p>
</div>
<div class="callout-content">
<ul>
<li>La instrucció <code>exit(0)</code> s’executa tant pel procés <strong>pare</strong> com pel <strong>fill</strong>.</li>
<li>Cada procés executa el seu propi <code>printf</code> de manera independent.</li>
</ul>
</div>
</div>
</div>
</div>
</div><div class="column" style="width:50%;">
<h4 id="ex2.c">ex2.c</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb5-1"><a aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb5-2"><a aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb5-3"><a aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb5-4"><a aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb5-5"><a aria-hidden="true" tabindex="-1"></a>    pid_t pid <span class="op">=</span> fork<span class="op">();</span></span>
<span id="cb5-6"><a aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>pid <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-7"><a aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Hello, I am the child.</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb5-8"><a aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>pid <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-9"><a aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Hello I am the father.</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb5-10"><a aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb5-11"><a aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span><span class="st">"Error creating process"</span><span class="op">);</span></span>
<span id="cb5-12"><a aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-13"><a aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb5-14"><a aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
<h4 id="execució">Execució</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a aria-hidden="true" tabindex="-1"></a><span class="fu">gcc</span> ex2.c <span class="at">-o</span> ex2 <span class="kw">&amp;&amp;</span> <span class="ex">./ex2</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div></div>
</section>
<section id="registres-i-fork" class="slide level2 smaller">
<h2>Registres i <code>fork()</code></h2>
<div class="columns">
<div class="column" style="width:70%;">
<div class="cell" data-reveal="true" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<pre class="mermaid mermaid-js">sequenceDiagram
    participant P as Pare
    participant K as Kernel
    participant C as Fill

    Note over P: Estat abans de fork()&lt;br&gt;RAX = ?, PC = adreça_crida_fork
    P-&gt;&gt;K: `fork()`
    activate K
    K--&gt;&gt;P: Retorn al Pare:&lt;br&gt;RAX = Child PID &lt;br&gt;PC = adreça_següent_instrucció
    K--&gt;&gt;C: Retorn al Fill:&lt;br&gt;RAX = 0&lt;br&gt;PC = adreça_següent_instrucció
    deactivate K

    par Execució paral·lela des del mateix punt
        P--&gt;&gt;P: Pare: Continua l'execució.(`if (RAX &gt; 0)`)
        C--&gt;&gt;C: Fill: Continua l'execució.(`if (RAX == 0)`)
    end

    Note over P,C: Ambdós processos s'executen de manera independent
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div><div class="column" style="width:30%;">
<div class="cell" data-reveal="true" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<pre class="mermaid mermaid-js">sequenceDiagram
    participant P as Pare
    participant K as Kernel

    Note over P: Estat abans de fork()&lt;br&gt;RAX = ?, PC = adreça_crida_fork
    P-&gt;&gt;K: `fork()`
    activate K
   
    alt Error a `fork()`
        P--xK: Retorna al pare:&lt;br&gt;RAX = -1
        Note over P: `errno` s'estableix.
    end

</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<div title="Observació">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Observació</strong></p>
</div>
<div class="callout-content">
<p>A l’arquitectura x86, el registre <strong>RAX</strong> s’utilitza per emmagatzemar el valor de retorn de la crida al sistema <code>fork()</code>. En altres arquitectures, s’utilitzen registres equivalents (sovint <em>R0</em> o <em>X0</em>).</p>
</div>
</div>
</div>
</div>
</div></div>
</section>
<section id="gestió-derrors-fork" class="slide level2 smaller">
<h2>Gestió d’errors: <code>fork()</code></h2>
<table class="caption-top">
<colgroup>
<col style="width: 18%">
<col style="width: 18%">
<col style="width: 63%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Error</th>
<th style="text-align: left;">Descripció</th>
<th style="text-align: left;">Raons</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><em>EAGAIN</em></td>
<td style="text-align: left;">S’han assolit els límits del sistema.</td>
<td style="text-align: left;">- Límits de processos (<strong>RLIMIT_NPROC</strong>)<br>- Límits de fils (<em>threads-max</em>)<br>- Esgotament dels PIDs disponibles (<em>pid_max</em>)<br>- Límits de cgroup</td>
</tr>
<tr class="even">
<td style="text-align: left;"><em>ENOMEM</em></td>
<td style="text-align: left;">Memòria del Kernel insuficient.</td>
<td style="text-align: left;">- Escassetat de RAM o Swap<br>- Problemes amb els espais de noms PID</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><em>ENOSYS</em></td>
<td style="text-align: left;"><code>fork()</code> no és compatible.</td>
<td style="text-align: left;">- Maquinari sense unitat de gestió de memòria (<em>MMU</em>)<br>- SO no compatible amb <code>fork()</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><em>ERESTARTNOINTR</em></td>
<td style="text-align: left;">Crida interrompuda i reiniciada.</td>
<td style="text-align: left;">Intern al Kernel, no és un error vist directament per l’aplicació.</td>
</tr>
</tbody>
</table>
</section>
<section id="forkbomb" class="slide level2 smaller">
<h2>Forkbomb</h2>
<div class="columns">
<div class="column" style="width:50%;">
<div title="Què és una Forkbomb?">
<div class="callout callout-warning callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Què és una Forkbomb?</strong></p>
</div>
<div class="callout-content">
<p>A <strong>forkbomb</strong> és un atac de denegació de servei que crea ràpidament un nombre massiu de processos, sobrecarregant els recursos del sistema i fent-lo inoperable.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb7-1"><a aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb7-2"><a aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-3"><a aria-hidden="true" tabindex="-1"></a>        fork<span class="op">();</span></span>
<span id="cb7-4"><a aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</div>
<div title="Mecanismes de Protecció">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Mecanismes de Protecció</strong></p>
</div>
<div class="callout-content">
<p>El nucli implementa dos mecanismes per prevenir les <em>forkbombs</em>:</p>
<ol type="1">
<li><strong>Límits de processos per usuari</strong>: Cada usuari té un límit configurable sobre el nombre de processos que pot crear, establert per <code>ulimit -u</code>.</li>
<li><strong>Límit global de processos</strong>: El sistema té un límit global sobre el nombre total de processos que pot crear, configurat per <code>pid_max</code> (<em>típicament 32768</em>).</li>
</ol>
</div>
</div>
</div>
</div>
</div><div class="column" style="width:50%;">
<div class="cell" data-reveal="true" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<pre class="mermaid mermaid-js">sequenceDiagram
    participant P as Procés Forkbomb 
    participant K as Nucli (Kernel)
    
    P-&gt;&gt;K: fork() (1r intent)
    activate K
    K--&gt;&gt;P: Retorna PID del fill1
    deactivate K
    
    par Creació Exponencial
        P-&gt;&gt;K: fork() (2n intent)
        activate K
        K--&gt;&gt;P: Retorna PID del fill2
        deactivate K
        
        fork1-&gt;&gt;K: fork() (1r fill)
        activate K
        K--&gt;&gt;fork1: Retorna PID del fill3
        deactivate K
    end
    
    Note over K: Processos creats: 4
    
    loop Fase de Saturació
        P/fills-&gt;&gt;K: fork() (Nou intent)
        activate K
        alt Abans del límit
            K--&gt;&gt;P/fills: Retorna nou PID
        else Després del límit
            K--&gt;&gt;P/fills: Retorna -1 (EAGAIN)
        end
        deactivate K
    end
    
    Note over K: Estat Final:&lt;br&gt;- Límit de processos assolit&lt;br&gt;- CPU al 100%&lt;br&gt;- Nous forks bloquejats.
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div></div>
</section>
<section id="exemple-fork-and-gdb" class="slide level2 smaller">
<h2>Exemple: <code>fork()</code> and GDB</h2>
<div class="center-container">
<p><video data-src="../figures/slides/03-create/ex2.mov" controls=""><a href="../figures/slides/03-create/ex2.mov">Video</a></video></p>
</div>
</section>
<section id="gestió-de-memòria-fork" class="slide level2 smaller">
<h2>Gestió de Memòria · <code>fork()</code></h2>
<div class="columns">
<div class="column" style="width:50%;">
<p><img data-src="../figures/slides/03-create/copia-exacta.png" class="smaller"></p>
</div><div class="column" style="width:50%;">
<div title="Observacions">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Observacions</strong></p>
</div>
<div class="callout-content">
<ol type="1">
<li>En el moment de <code>fork()</code> <span class="math inline">\(\rightarrow\)</span> El <strong>pare</strong> i el <strong>fill</strong> comparteixen el mateix espai d’adreces <strong>físic</strong>.</li>
<li>Cada procés té el seu propi espai d’adreces <strong>virtual</strong>, que <em>tradueix</em> a l’espai d’adreces <strong>físic</strong> compartit.</li>
</ol>
</div>
</div>
</div>
</div>
<div title="Duplicats idèntics">
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Duplicats idèntics</strong></p>
</div>
<div class="callout-content">
<p>Inicialment, el <strong>pare</strong> i el <strong>fill</strong> són <em>duplicats idèntics</em>. A partir d’aquest moment, cada procés té el seu propi espai d’adreces virtual, i <strong>qualsevol modificació en un no afecta l’altre</strong>.</p>
</div>
</div>
</div>
</div>
</div></div>
</section>
<section id="duplicació-rightarrow-independència" class="slide level2 smaller">
<h2>Duplicació <span class="math inline">\(\rightarrow\)</span> Independència</h2>
<div class="columns">
<div class="column" style="width:50%;">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb8-1"><a aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">11</span><span class="op">;</span> <span class="co">//.data</span></span>
<span id="cb8-2"><a aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb8-3"><a aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> j<span class="op">=</span> <span class="dv">22</span><span class="op">;</span> <span class="co">// Stack</span></span>
<span id="cb8-4"><a aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">*</span>z <span class="op">=</span> malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">));</span> <span class="co">// Heap</span></span>
<span id="cb8-5"><a aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a aria-hidden="true" tabindex="-1"></a>    pid_t pid<span class="op">;</span></span>
<span id="cb8-7"><a aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>pid<span class="op">=</span>fork<span class="op">())</span></span>
<span id="cb8-8"><a aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb8-9"><a aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="dv">0</span><span class="op">:</span></span>
<span id="cb8-10"><a aria-hidden="true" tabindex="-1"></a>        i <span class="op">*=</span> <span class="dv">3</span><span class="op">;</span> </span>
<span id="cb8-11"><a aria-hidden="true" tabindex="-1"></a>        j <span class="op">*=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb8-12"><a aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span>z<span class="op">=</span><span class="dv">44</span><span class="op">;</span></span>
<span id="cb8-13"><a aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb8-14"><a aria-hidden="true" tabindex="-1"></a>    <span class="cf">default</span><span class="op">:</span></span>
<span id="cb8-15"><a aria-hidden="true" tabindex="-1"></a>        sleep<span class="op">(</span><span class="dv">3</span><span class="op">);</span></span>
<span id="cb8-16"><a aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span>z<span class="op">=</span><span class="dv">55</span><span class="op">;</span></span>
<span id="cb8-17"><a aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb8-18"><a aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-19"><a aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb8-20"><a aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"PID=</span><span class="sc">%ld</span><span class="st"> </span><span class="sc">%s</span><span class="st"> data=</span><span class="sc">%d</span><span class="st"> stack=</span><span class="sc">%d</span><span class="st"> heap=</span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> </span>
<span id="cb8-21"><a aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span><span class="dt">long</span><span class="op">)</span> getpid<span class="op">(),</span> </span>
<span id="cb8-22"><a aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span>pid <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">?</span> <span class="st">"(child) "</span> <span class="op">:</span> <span class="st">"(parent)"</span><span class="op">,</span>i<span class="op">,</span>j<span class="op">,*</span>z<span class="op">);</span></span>
<span id="cb8-23"><a aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span>z<span class="op">);</span></span>
<span id="cb8-24"><a aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb8-25"><a aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div><div class="column" style="width:50%;">
<div class="cell" data-reveal="true" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<pre class="mermaid mermaid-js">sequenceDiagram
    participant P as Pare
    participant OS as Kernel
    participant C as Fill

    Note over P: i=11, j=22, z=NULL
    P-&gt;&gt;OS: `fork()`

    par
        C-&gt;&gt;OS: i *= 3 (.data) [i es converteix en 33]
        activate OS
        OS--&gt;&gt;C: Duplica Pàgina, Actualitza VMA
        deactivate OS

        C-&gt;&gt;OS: j *= 3 (stack) [j es converteix en 66]
        activate OS
        OS--&gt;&gt;C: Duplica Pàgina, Actualitza VMA
        deactivate OS

        C-&gt;&gt;OS: *z = 44 (heap) [z apunta a 44]
        activate OS
        OS--&gt;&gt;C: Duplica Pàgina, Actualitza VMA
        deactivate OS
    end

    P-&gt;&gt;OS: *z = 55 (heap) [z apunta a 55]
    activate OS
    OS--&gt;&gt;P: Duplica Pàgina, Actualitza VMA
    deactivate OS

    C-&gt;&gt;C: Prints: data=33 stack=66 heap=44
    P-&gt;&gt;P: Prints: data=11 stack=22 heap=55
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div></div>
</section>
<section id="copy-on-write-cow" class="slide level2 smaller">
<h2>Copy-On-Write (CoW)</h2>
<div class="columns">
<div class="column" style="width:65%;">
<div class="cell" data-reveal="true" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<pre class="mermaid mermaid-js">sequenceDiagram
    participant P as Pare
    participant M as Memòria
    participant C as Fill

    P-&gt;&gt;C: Crea Procés Fill
    M-&gt;&gt;C: Comparteix Pàgina X


    rect rgba(255, 200, 200, 0.2)
    Note over P,C: Post-fork - Operació escriptura
    P-&gt;&gt;M: Modifica Pàgina X
    M-&gt;&gt;P: Crea còpia privada X' (RW)
    M-&gt;&gt;C: Manté original X (RO)

    end
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div><div class="column" style="width:35%;">
<div title="Com funciona?">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Com funciona?</strong></p>
</div>
<div class="callout-content">
<p>Quan <code>fork()</code> crea un nou procés, el pare i el fill inicialment comparteixen les mateixes pàgines de memòria. Aquestes es marquen com a <strong>només lectura</strong> per a ambdós processos.</p>
<ol type="1">
<li>Crea una <strong>còpia privada</strong> d’aquella pàgina per al procés que escriu.</li>
<li>Assigna la nova pàgina amb permisos d’escriptura.</li>
<li>Manté la transparència per a l’aplicació.</li>
</ol>
<p>Aquest mecanisme optimitza tant el temps com la memòria, ja que només es copia la informació modificada.</p>
</div>
</div>
</div>
</div>
</div></div>
</section>
<section id="fork-or-clone" class="slide level2 smaller">
<h2><code>fork()</code> or <code>clone()</code></h2>
<div class="columns">
<div class="column" style="width:40%;">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb9-1"><a aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb9-2"><a aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb9-3"><a aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb9-4"><a aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb9-5"><a aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb9-6"><a aria-hidden="true" tabindex="-1"></a>main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb9-7"><a aria-hidden="true" tabindex="-1"></a>    pid_t pid<span class="op">;</span></span>
<span id="cb9-8"><a aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">((</span>pid <span class="op">=</span> fork<span class="op">())</span> <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-9"><a aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb9-10"><a aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-11"><a aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">0</span><span class="op">);</span> </span>
<span id="cb9-12"><a aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a aria-hidden="true" tabindex="-1"></a><span class="fu">gcc</span> ex7.c <span class="at">-o</span> ex7</span>
<span id="cb10-2"><a aria-hidden="true" tabindex="-1"></a><span class="ex">strace</span> <span class="at">-c</span> ./ex7</span>
<span id="cb10-3"><a aria-hidden="true" tabindex="-1"></a><span class="ex">strace</span> <span class="at">-e</span> trace=process ./ex7</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="fragment" title="Exercicis">
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Exercicis</strong></p>
</div>
<div class="callout-content">
<ul>
<li>Investiga les simplificacions que <code>fork()</code> fa sobre <code>clone()</code>.</li>
<li>Adapta el codi per utilitzar <code>clone()</code> directament.</li>
</ul>
</div>
</div>
</div>
</div>
</div><div class="column" style="width:60%;">
<div title="Observacions">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Observacions</strong></p>
</div>
<div class="callout-content">
<ol type="1">
<li><strong>Absència de <code>fork()</code> en strace</strong>:
<ul>
<li>No hi ha una invocació directa a la crida al sistema <code>fork()</code>.</li>
<li>En canvi, es detecta una crida a <code>clone()</code>, que és la crida al sistema principal del nucli de Linux per crear tant processos com fils.</li>
</ul></li>
<li><strong>Relació entre <code>fork()</code> i <code>clone()</code></strong>:
<ul>
<li>La funció <code>fork()</code>, definida a la biblioteca estàndard de C (<em>glibc</em>), actua com un embolcall que crida internament a <code>clone()</code> amb un conjunt de paràmetres predeterminats.</li>
</ul></li>
<li><strong><code>clone()</code> i els seus flags</strong>:
<ul>
<li><strong>SIGCHLD</strong>: Configura el mecanisme de notificació per al procés pare.</li>
<li><strong>CLONE_CHILD_SETTID</strong>: Estableix l’identificador de fil (TID) al procés fill.</li>
<li><strong>CLONE_CHILD_CLEARTID</strong>: Neteja automàticament aquest identificador en finalitzar.</li>
</ul></li>
</ol>
</div>
</div>
</div>
</div>
</div></div>
</section>
<section id="indeterminisme-fork" class="slide level2 smaller">
<h2>Indeterminisme <code>fork()</code></h2>
<div class="columns">
<div class="column" style="width:50%;">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb11-1"><a aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb11-2"><a aria-hidden="true" tabindex="-1"></a>  pid_t pid<span class="op">;</span></span>
<span id="cb11-3"><a aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">((</span>pid <span class="op">=</span> fork<span class="op">())</span> <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-4"><a aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb11-5"><a aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>pid <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span>  </span>
<span id="cb11-6"><a aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"My name is Rhaenyra"</span><span class="op">)</span></span>
<span id="cb11-7"><a aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb11-8"><a aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"My name is King Viserys"</span><span class="op">);</span></span>
<span id="cb11-9"><a aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb11-10"><a aria-hidden="true" tabindex="-1"></a>  exit<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb11-11"><a aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div><div class="column" style="width:50%;">
<p><img data-src="../figures/slides/03-create/no-determinisme.png" style="width:80.0%"></p>
</div></div>
<div title="Observacions">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Observacions</strong></p>
</div>
<div class="callout-content">
<ul>
<li>La execució del programa és <strong>no determinista</strong>.</li>
<li>El procés <strong>pare</strong> i el <strong>fill</strong> poden executar-se en <strong>qualsevol ordre</strong>.</li>
<li>L’<strong>planificador</strong> del sistema operatiu decideix quin procés s’executa en un moment donat.</li>
</ul>
</div>
</div>
</div>
</div>
</section>
<section id="wait" class="slide level2 smaller">
<h2><code>wait()</code></h2>
<div class="columns">
<div class="column" style="width:55%;">
<div title="`wait()`">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong><code>wait()</code></strong></p>
</div>
<div class="callout-content">
<p>La crida al sistema <code>wait()</code> permet que un procés pare bloquegi la seva execució fins que un dels seus processos fills canviï d’estat (normalment, quan finalitza). També recupera informació sobre el fill que ha canviat d’estat.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb12-1"><a aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb12-2"><a aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/wait.h&gt;</span></span>
<span id="cb12-3"><a aria-hidden="true" tabindex="-1"></a>pid_t wait<span class="op">(</span><span class="dt">int</span> <span class="op">*</span>_Nullable wstatus<span class="op">);</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</div>
<div title="Propietats">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Propietats</strong></p>
</div>
<div class="callout-content">
<ul>
<li>Retorna el PID del procés fill que ha canviat d’estat, o -1 en cas d’error.</li>
<li>Si <code>wstatus</code> no és <strong>NULL</strong>, l’estat de sortida del fill s’hi emmagatzema.</li>
</ul>
</div>
</div>
</div>
</div>
<div title="`SIGCHLD`">
<div class="callout callout-warning callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong><code>SIGCHLD</code></strong></p>
</div>
<div class="callout-content">
<p>El senyal <code>SIGCHLD</code> s’envia al procés pare quan un fill canvia d’estat.</p>
</div>
</div>
</div>
</div>
</div><div class="column" style="width:45%;">
<div class="cell" data-reveal="true" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<pre class="mermaid mermaid-js">sequenceDiagram
    participant P as Pare
    participant K as Kernel
    participant C as Fill
    P-&gt;&gt;K: fork()
    K--&gt;&gt;C: Crea Procés Fill
    activate C
    K--&gt;&gt;P: Retorna PID del Fill
    C-&gt;&gt;C: Execució del Fill
    P-&gt;&gt;K: wait()
    K-&gt;&gt;K: Bloqueja pare fins que el fill canviï d'estat
    C-&gt;&gt;K: exit(42)
    deactivate C
    K-&gt;&gt;K: PCB retingut 
    K--&gt;&gt;P: notificació SIGCHLD
    P-&gt;&gt;K: Llegeix estat del Fill Reads
    K-&gt;&gt;K: Allibera PCB fill
    K--&gt;&gt;P: Retorna estat (42)
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div></div>
</section>
<section id="example-wait" class="slide level2 smaller">
<h2>Example: <code>wait()</code></h2>
<div class="columns">
<div class="column" style="width:60%;">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb13-1"><a aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb13-2"><a aria-hidden="true" tabindex="-1"></a>    pid_t pid<span class="op">;</span></span>
<span id="cb13-3"><a aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">((</span>pid <span class="op">=</span> fork<span class="op">())</span> <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-4"><a aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb13-5"><a aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>pid <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span>  </span>
<span id="cb13-6"><a aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"My name is Rhaenyra"</span><span class="op">)</span></span>
<span id="cb13-7"><a aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb13-8"><a aria-hidden="true" tabindex="-1"></a>        wait<span class="op">(</span>NULL<span class="op">);</span></span>
<span id="cb13-9"><a aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"My name is King Viserys"</span><span class="op">);</span></span>
<span id="cb13-10"><a aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb13-11"><a aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb13-12"><a aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div title="Observacions">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Observacions</strong></p>
</div>
<div class="callout-content">
<ul>
<li>El procés <strong>pare</strong> utilitza <code>wait()</code> per esperar que el seu <strong>fill</strong> finalitzi abans de continuar. Això assegura que la sortida serà sempre <em>My name is King Viserys</em> després de <em>My name is Rhaenyra</em>.</li>
<li>No garanteix que el fill s’executi primer. Només assegura que el fill acabi abans que el pare reprengui la seva execució.</li>
<li><code>wait()</code> és per a un <em>pare</em> que espera un <em>fill</em>. Un <em>fill</em> no pot utilitzar-lo per esperar el seu <em>pare</em>.</li>
<li>Altres mecanismes, com <code>pause()</code> i <em>senyals</em>, són necessaris per a diferents escenaris de sincronització.</li>
</ul>
</div>
</div>
</div>
</div>
</div><div class="column" style="width:40%;">
<div class="cell" data-reveal="true" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<pre class="mermaid mermaid-js">sequenceDiagram
    participant P as Pare (PID X)
    participant K as Kernel
    participant C as Fill (PID Y)
    
    P-&gt;&gt;K: fork()
    K--&gt;&gt;C: Crea Procés
    K--&gt;&gt;P: Retorna PID Y
    K--&gt;&gt;C: Returns 0
    
    P-&gt;&gt;K: wait()
    Note right of P: Estat: WAITING
    K-&gt;&gt;K: Planificador: continua Fill
    
    activate C
    C-&gt;&gt;C: printf("My name is Rhaenyra")
    C-&gt;&gt;K: exit(0)
    deactivate C
    
    K--&gt;&gt;P: SIGCHLD + status (0)
    Note right of P: Estat: RUNNING
    P-&gt;&gt;P: printf("My name is King Viserys")
    P-&gt;&gt;K: exit(0)
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div></div>
</section>
<section id="waitpid" class="slide level2 smaller">
<h2><code>waitpid()</code></h2>
<div class="columns">
<div class="column" style="width:60%;">
<div title="`waitpid()`">
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong><code>waitpid()</code></strong></p>
</div>
<div class="callout-content">
<p>Permet que un procés pare esperi de manera <strong>selectiva</strong> que un procés fill específic canviï d’estat. També proporciona més control sobre el comportament de l’espera mitjançant opcions addicionals.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb14-1"><a aria-hidden="true" tabindex="-1"></a>pid_t waitpid<span class="op">(</span>pid_t pid<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>_Nullable wstatus<span class="op">,</span> <span class="dt">int</span> options<span class="op">);</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</div>
<div title="`Options`">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong><code>Options</code></strong></p>
</div>
<div class="callout-content">
<ul>
<li><code>WNOHANG</code>: No bloquejar si cap procés fill ha canviat d’estat. Això significa que la crida retorna immediatament.</li>
<li><code>WUNTRACED</code>: També retorna per processos fills que han estat aturats (per exemple, per un senyal).</li>
<li><code>WCONTINUED</code>: També retorna per processos fills que han estat reprès després d’haver estat aturat (<em>disponible des de Linux 2.6.10</em>).</li>
</ul>
</div>
</div>
</div>
</div>
</div><div class="column" style="width:40%;">
<div title="Valors de `pid`">
<div class="callout callout-caution callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Valors de <code>pid</code></strong></p>
</div>
<div class="callout-content">
<ul>
<li><span class="math inline">\(\lt -1\)</span>: Espera qualsevol procés fill el PID del qual sigui igual al valor absolut de pid.</li>
<li><span class="math inline">\(= -1\)</span>: Espera qualsevol procés fill.</li>
<li><span class="math inline">\(= 0\)</span>: Espera qualsevol procés fill el PID del qual sigui igual al del procés que crida (el pare).</li>
<li><span class="math inline">\(\gt 0\)</span>: Espera el procés fill específic identificat per aquest valor de pid.</li>
</ul>
</div>
</div>
</div>
</div>
<div title="Observació">
<div class="callout callout-warning callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Observació</strong></p>
</div>
<div class="callout-content">
<p><code>wait(NULL)</code> és equivalent a <code>waitpid(-1, NULL, 0)</code></p>
</div>
</div>
</div>
</div>
</div></div>
</section>
<section id="example-waitpid" class="slide level2 smaller">
<h2>Example: <code>waitpid()</code></h2>
<div class="columns">
<div class="column" style="width:40%;">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb15-1"><a aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-2"><a aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb15-3"><a aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Dracarys!</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb15-4"><a aria-hidden="true" tabindex="-1"></a>    pid_t drogon <span class="op">=</span> fork<span class="op">();</span></span>
<span id="cb15-5"><a aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>drogon <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span> </span>
<span id="cb15-6"><a aria-hidden="true" tabindex="-1"></a>        sleep<span class="op">(</span><span class="dv">1</span><span class="op">);</span>  </span>
<span id="cb15-7"><a aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Fire and blood in KL!</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb15-8"><a aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span><span class="dv">0</span><span class="op">);</span> </span>
<span id="cb15-9"><a aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb15-10"><a aria-hidden="true" tabindex="-1"></a>    pid_t rhaegal <span class="op">=</span> fork<span class="op">();</span></span>
<span id="cb15-11"><a aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>rhaegal <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-12"><a aria-hidden="true" tabindex="-1"></a>        sleep<span class="op">(</span><span class="dv">3</span><span class="op">);</span> </span>
<span id="cb15-13"><a aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Flying over Saltspear</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb15-14"><a aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb15-15"><a aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb15-16"><a aria-hidden="true" tabindex="-1"></a>    waitpid<span class="op">(</span>rhaegal<span class="op">,</span> NULL<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb15-17"><a aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Rhaegal has returned</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb15-18"><a aria-hidden="true" tabindex="-1"></a>    waitpid<span class="op">(</span>drogon<span class="op">,</span> NULL<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb15-19"><a aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Drogon has returned</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb15-20"><a aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb15-21"><a aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div><div class="column" style="width:55%;">
<div class="cell" data-reveal="true" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<pre class="mermaid mermaid-js">sequenceDiagram
    participant D as Daenerys
    participant K as Kernel
    participant D1 as Drogon
    participant D2 as Rhaegal
  
    Note over D: dracarys!
    D-&gt;&gt;K: fork() (Drogon)
    activate D1
    D-&gt;&gt;K: fork() (Rhaegal)
    activate D2

    Note over D1: sleep(1)
    D1-&gt;&gt;D1: printf("Fire and blood in KL!")
    D1-&gt;&gt;K: exit(0)
    deactivate D1

    Note over D2: sleep(3)
    D2-&gt;&gt;D2: printf("Flying over Saltspear")
    D2-&gt;&gt;K: exit(0)
    deactivate D2

    D-&gt;&gt;K: waitpid(Rhaegal)
    K--&gt;&gt;D: Returns Rhaegal's PID (Rhaegal finished)
    D-&gt;&gt;D: printf("Rhaegal has returned")
    
    D-&gt;&gt;K: waitpid(Drogon)
    K--&gt;&gt;D: Returns Drogon's PID (Drogon finished)
    D-&gt;&gt;D: printf("Drogon has returned")

    D-&gt;&gt;K: exit(0)
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div></div>
</section>
<section id="waitwaitpid-macros" class="slide level2 smaller">
<h2><code>wait()</code>/<code>waitpid()</code>: Macros</h2>
<p>El paràmetre <strong>status</strong> de <code>wait()</code> o <code>waitpid()</code> és un enter (<em>int</em>) que conté informació codificada sobre com ha finalitzat (o ha canviat d’estat) el procés fill.</p>
<div title="x86">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>x86</strong></p>
</div>
<div class="callout-content">
<table class="caption-top">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Bits</th>
<th style="text-align: left;">Camp</th>
<th style="text-align: left;">Descripció</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0-6</td>
<td style="text-align: left;">Codi de Senyal</td>
<td style="text-align: left;">El número del senyal que ha causat la terminació del fill, si n’hi ha. (<code>WTERMSIG(status)</code>).</td>
</tr>
<tr class="even">
<td>7</td>
<td style="text-align: left;">Indicador de Core Dump</td>
<td style="text-align: left;">Indicador si s’ha generat un core dump. (<code>WCOREDUMP(status)</code>).</td>
</tr>
<tr class="odd">
<td>8-15</td>
<td style="text-align: left;">Exit</td>
<td style="text-align: left;">El valor de retorn de l’<code>exit()</code> del fill. (<code>WEXITSTATUS(status)</code>)</td>
</tr>
<tr class="even">
<td>16-31</td>
<td style="text-align: left;">-</td>
<td style="text-align: left;">Generalment no utilitzat o reservat.</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div title="Què passa amb `exit(256)`?">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Què passa amb <code>exit(256)</code>?</strong></p>
</div>
<div class="callout-content">
<p>El número 256 es converteix en un codi de sortida de 0 perquè els codis de sortida solen estar limitats a 8 bits (0-255). Això es deu al fet que el sistema operatiu només utilitza els 8 bits menys significatius per al codi de sortida. Per tant, <code>WEXITSTATUS(status)</code> retornarà 0.</p>
</div>
</div>
</div>
</div>
</section>
<section id="waitwaitpid-status-macros-i" class="slide level2 smaller">
<h2><code>wait()</code>/<code>waitpid()</code>: Status Macros (I)</h2>
<ul>
<li><strong><code>WIFEXITED(status)</code></strong>: Retorna cert (no zero) si el procés fill ha finalitzat normalment mitjançant <code>exit()</code>.</li>
<li><strong><code>WEXITSTATUS(status)</code></strong>: Retorna el codi de sortida del fill. <em>Només</em> vàlid si <code>WIFEXITED(status)</code> és cert.</li>
<li><strong><code>WIFSIGNALED(status)</code></strong>: Retorna cert si el canvi d’estat del fill ha estat causat per un senyal.</li>
<li><strong><code>WTERMSIG(status)</code></strong>: Retorna el número del senyal que ha causat la terminació del procés fill. <em>Només</em> vàlid si <code>WIFSIGNALED(status)</code> és cert.</li>
</ul>
</section>
<section id="waitwaitpid-status-macros-ii" class="slide level2 smaller">
<h2><code>wait()</code>/<code>waitpid()</code>: Status Macros (II)</h2>
<ul>
<li><strong><code>WCOREDUMP(status)</code></strong>: Retorna cert si el fill ha terminat i ha generat un core dump. <em>Només</em> vàlid si <code>WIFSIGNALED(status)</code> és cert. (<em>La disponibilitat pot variar</em>).</li>
<li><strong><code>WIFSTOPPED(status)</code></strong>: Retorna cert si el fill ha estat suspès (<em>aturat</em>) per un senyal. Per detectar això, <code>waitpid()</code> ha de ser cridat amb l’opció <code>WUNTRACED</code>.</li>
<li><strong><code>WSTOPSIG(status)</code></strong>: Retorna el número del senyal que ha aturat el fill. <em>Només</em> vàlid si <code>WIFSTOPPED(status)</code> és cert.</li>
<li><strong><code>WIFCONTINUED(status)</code></strong>: Retorna cert si un fill que havia estat aturat ha estat reactivat (amb <code>SIGCONT</code>). Requereix l’opció <code>WCONTINUED</code> en <code>waitpid()</code> (<em>Linux kernel 2.6 i posteriors</em>).</li>
</ul>
</section>
<section id="exemple-waitpid-macros" class="slide level2 smaller">
<h2>Exemple: <code>waitpid()</code> &amp; Macros</h2>
<div class="columns">
<div class="column" style="width:50%;">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode c code-overflow-scroll code-overflow-wrap code-with-copy"><code class="sourceCode c"><span id="cb16-1"><a aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>argv<span class="op">[]){</span></span>
<span id="cb16-2"><a aria-hidden="true" tabindex="-1"></a>pid_t pid<span class="op">,</span> w<span class="op">;</span> <span class="dt">int</span> status<span class="op">;</span></span>
<span id="cb16-3"><a aria-hidden="true" tabindex="-1"></a>pid <span class="op">=</span> fork<span class="op">();</span></span>
<span id="cb16-4"><a aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>pid <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span> </span>
<span id="cb16-5"><a aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>argc <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> pause<span class="op">();</span> exit<span class="op">(</span>atoi<span class="op">(</span>argv<span class="op">[</span><span class="dv">1</span><span class="op">]));</span></span>
<span id="cb16-6"><a aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>                    </span>
<span id="cb16-7"><a aria-hidden="true" tabindex="-1"></a>  <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb16-8"><a aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> waitpid<span class="op">(</span>pid<span class="op">,</span> <span class="op">&amp;</span>status<span class="op">,</span> WUNTRACED <span class="op">|</span> WCONTINUED<span class="op">);</span></span>
<span id="cb16-9"><a aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>w <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-10"><a aria-hidden="true" tabindex="-1"></a>      perror<span class="op">(</span><span class="st">"waitpid"</span><span class="op">);</span> exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb16-11"><a aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-12"><a aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>WIFEXITED<span class="op">(</span>status<span class="op">))</span> <span class="op">{</span></span>
<span id="cb16-13"><a aria-hidden="true" tabindex="-1"></a>      printf<span class="op">(</span><span class="st">"exited, [</span><span class="sc">%d</span><span class="st">] status=</span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> </span>
<span id="cb16-14"><a aria-hidden="true" tabindex="-1"></a>             pid<span class="op">,</span> WEXITSTATUS<span class="op">(</span>status<span class="op">));</span></span>
<span id="cb16-15"><a aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>WIFSIGNALED<span class="op">(</span>status<span class="op">))</span> <span class="op">{</span></span>
<span id="cb16-16"><a aria-hidden="true" tabindex="-1"></a>      printf<span class="op">(</span><span class="st">"killed by signal, </span></span>
<span id="cb16-17"><a aria-hidden="true" tabindex="-1"></a>        <span class="op">[%</span>d<span class="op">]</span> <span class="op">-&gt;</span> <span class="op">%</span>d\n<span class="st">", pid, WTERMSIG(status));</span></span>
<span id="cb16-18"><a aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>WIFSTOPPED<span class="op">(</span>status<span class="op">))</span> <span class="op">{</span></span>
<span id="cb16-19"><a aria-hidden="true" tabindex="-1"></a>      printf<span class="op">(</span><span class="st">"stopped by signal [</span><span class="sc">%d</span><span class="st">] </span></span>
<span id="cb16-20"><a aria-hidden="true" tabindex="-1"></a>        <span class="op">-&gt;</span> <span class="op">%</span>d\n<span class="st">", pid, WSTOPSIG(status));</span></span>
<span id="cb16-21"><a aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>WIFCONTINUED<span class="op">(</span>status<span class="op">))</span> <span class="op">{</span> </span>
<span id="cb16-22"><a aria-hidden="true" tabindex="-1"></a>      printf<span class="op">(</span><span class="st">"continued</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span> <span class="op">}</span></span>
<span id="cb16-23"><a aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">while</span> <span class="op">(!</span>WIFEXITED<span class="op">(</span>status<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>WIFSIGNALED<span class="op">(</span>status<span class="op">));</span></span>
<span id="cb16-24"><a aria-hidden="true" tabindex="-1"></a>  exit<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb16-25"><a aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div><div class="column" style="width:50%;">
<p><img data-src="../figures/slides/03-create/waitpid-signals.png"></p>
<div class="fragment" title="Pregunta?">
<div class="callout callout-warning callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Pregunta?</strong></p>
</div>
<div class="callout-content">
<p>Quin serà el resultat després d’executar <code>./ex8 42</code>?</p>
</div>
</div>
</div>
</div>
</div></div>
</section>
<section id="estat-zombie" class="slide level2 smaller">
<h2>Estat Zombie</h2>
<div title="TASK_ZOMBIE">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>TASK_ZOMBIE</strong></p>
</div>
<div class="callout-content">
<p>Després d’executar <code>exit()</code>, un procés no s’elimina immediatament. En lloc d’això, entra en l’estat <strong>zombie</strong> fins que el seu procés pare processa la notificació <code>SIGCHLD</code> o crida a <code>wait()</code> o <code>waitpid()</code>. Si el pare no ho fa, el fill roman en aquest estat indefinidament.</p>
</div>
</div>
</div>
</div>
<div class="columns">
<div class="column" style="width:50%;">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb17-1"><a aria-hidden="true" tabindex="-1"></a><span class="co">// kernel/exit.c</span></span>
<span id="cb17-2"><a aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> do_exit<span class="op">(</span><span class="dt">long</span> code<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-3"><a aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> task_struct <span class="op">*</span>tsk <span class="op">=</span> current<span class="op">;</span></span>
<span id="cb17-4"><a aria-hidden="true" tabindex="-1"></a>    tsk<span class="op">-&gt;</span>exit_code <span class="op">=</span> code<span class="op">;</span>          </span>
<span id="cb17-5"><a aria-hidden="true" tabindex="-1"></a>    exit_files<span class="op">(</span>tsk<span class="op">);</span>               </span>
<span id="cb17-6"><a aria-hidden="true" tabindex="-1"></a>    exit_mm<span class="op">(</span>tsk<span class="op">);</span>                 </span>
<span id="cb17-7"><a aria-hidden="true" tabindex="-1"></a>    exit_notify<span class="op">(</span>tsk<span class="op">,</span> group_dead<span class="op">);</span>   </span>
<span id="cb17-8"><a aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div><div class="column" style="width:50%;">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb18-1"><a aria-hidden="true" tabindex="-1"></a><span class="co">// kernel/exit.c</span></span>
<span id="cb18-2"><a aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> exit_notify<span class="op">(</span><span class="kw">struct</span> task_struct <span class="op">*</span>tsk<span class="op">,</span> </span>
<span id="cb18-3"><a aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> group_dead<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-4"><a aria-hidden="true" tabindex="-1"></a>    tsk<span class="op">-&gt;</span>exit_state <span class="op">=</span> EXIT_ZOMBIE<span class="op">;</span>  </span>
<span id="cb18-5"><a aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>group_dead<span class="op">)</span></span>
<span id="cb18-6"><a aria-hidden="true" tabindex="-1"></a>        tsk<span class="op">-&gt;</span>exit_state <span class="op">|=</span> EXIT_DEAD<span class="op">;</span></span>
<span id="cb18-7"><a aria-hidden="true" tabindex="-1"></a>    tsk<span class="op">-&gt;</span>exit_signal <span class="op">:</span> SIGCHLD<span class="op">;</span></span>
<span id="cb18-8"><a aria-hidden="true" tabindex="-1"></a>    do_notify_parent<span class="op">(</span>tsk<span class="op">,</span> sig<span class="op">);</span></span>
<span id="cb18-9"><a aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div></div>
</section>
<section id="orfes-i" class="slide level2 smaller">
<h2>Orfes (I)</h2>
<p>Un procés fill esdevé un <strong>orfe</strong> si el seu pare mor abans que ell. En aquest cas, el nucli reassigna el fill al procés <code>init</code> (PID 1), que és responsable de netejar els processos orfes.</p>
<div class="cell" data-reveal="true" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<pre class="mermaid mermaid-js">sequenceDiagram
    participant Pare
    participant Kernel
    participant Fill
    participant Init
    
    Parent-&gt;&gt;Kernel: exit() // Mor el pare
    Kernel-&gt;&gt;Kernel: find_zombie_children()
    Note right of Child: Orfe, fill sense pare
    Kernel-&gt;&gt;Child: reparent_to_init()
    loop Cada 0.5s
        Init-&gt;&gt;Kernel: wait()
        Kernel-&gt;&gt;Init: Retorna estat
        Kernel-&gt;&gt;Child: release_task()
    end
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="orfes-i-zombies" class="slide level2 smaller">
<h2>Orfes i Zombies</h2>
<table class="caption-top">
<colgroup>
<col style="width: 14%">
<col style="width: 34%">
<col style="width: 16%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th>Escenari</th>
<th>Mecanisme del Nucli</th>
<th>Temps</th>
<th>Consequències</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Pare Actiu</strong></td>
<td>Reté <code>task_struct</code> fins a <code>wait()</code></td>
<td>Indefinit</td>
<td>- Consumeix entrada a la taula de processos<br>- PID es manté ocupat</td>
</tr>
<tr class="even">
<td><strong>Pare Mort</strong></td>
<td><code>reparent_to_init()</code> (PPID←1)</td>
<td><span class="math inline">\(\le 1\)</span> ms</td>
<td>- Init neteja en segon pla (<code>init</code> periodicament crida <code>wait()</code>) <br>- Alliberació asíncrona</td>
</tr>
<tr class="odd">
<td><strong>Reinici del Sistema</strong></td>
<td><code>kill(pid, SIGKILL)</code></td>
<td>0</td>
<td>- Alliberació forçada (via <code>do_exit()</code> global) <br>- Sense garantia d’estat</td>
</tr>
<tr class="even">
<td><strong>Pare ignora SIGCHLD</strong></td>
<td>Zombie persistent</td>
<td><span class="math inline">\(\infty\)</span></td>
<td>- Requereix intervenció manual</td>
</tr>
</tbody>
</table>
</section>
<section id="example-factoria-de-zombies" class="slide level2 smaller">
<h2>Example: Factoria de Zombies</h2>
<div class="columns">
<div class="column" style="width:50%;">
<h4 id="zombie.c">zombie.c</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb19-1"><a aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb19-2"><a aria-hidden="true" tabindex="-1"></a>pid_t pid<span class="op">;</span> <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb19-3"><a aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb19-4"><a aria-hidden="true" tabindex="-1"></a>    pid <span class="op">=</span> fork<span class="op">();</span></span>
<span id="cb19-5"><a aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>pid <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-6"><a aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Zombie #</span><span class="sc">%d</span><span class="st"> born:</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span></span>
<span id="cb19-7"><a aria-hidden="true" tabindex="-1"></a>         i <span class="op">+</span> <span class="dv">1</span><span class="op">);</span> sleep<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb19-8"><a aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb19-9"><a aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"*drool* Boooo! </span></span>
<span id="cb19-10"><a aria-hidden="true" tabindex="-1"></a>           Arrgghh<span class="op">!</span> <span class="op">*</span>slobber<span class="op">*</span>\n<span class="st">");</span></span>
<span id="cb19-11"><a aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb19-12"><a aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb19-13"><a aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb19-14"><a aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb19-15"><a aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div><div class="column" style="width:40%;">
<h4 id="terminal-1">Terminal 1</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a></a><span class="ex">$</span> gcc zombie.c <span class="at">-o</span> zombie</span>
<span id="cb20-2"><a></a><span class="ex">$</span> ./zombie</span>
<span id="cb20-3"><a></a><span class="ex">Zombie</span> <span class="co">#1 born:</span></span>
<span id="cb20-4"><a></a><span class="ex">Zombie</span> <span class="co">#2 born:</span></span>
<span id="cb20-5"><a></a><span class="ex">Zombie</span> <span class="co">#3 born:</span></span>
<span id="cb20-6"><a></a><span class="ex">...</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
<h4 id="terminal-2">Terminal 2</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a></a><span class="ex">$</span> watch <span class="at">-n</span> 1 <span class="st">"ps u -C zombie"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div></div>

<aside><div>
<p>Inspired by <a href="https://www.refining-linux.org/archives/7-Dr.-Frankenlinux-or-how-to-create-zombie-processes.html" class="uri">https://www.refining-linux.org/archives/7-Dr.-Frankenlinux-or-how-to-create-zombie-processes.html</a></p>
</div></aside></section>
<section id="transformació-exec" class="slide level2 smaller">
<h2>Transformació: <code>exec()</code></h2>
<div class="columns">
<div class="column" style="width:65%;">
<div title="Processos Independents?">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Processos Independents?</strong></p>
</div>
<div class="callout-content">
<p>Tots els processos (excepte PID 1) tenen un pare i es creen amb <code>clone()</code>. Però com poden <code>bash</code> i <code>ls</code> ser programes separats?</p>
</div>
</div>
</div>
</div>
<div title="Syscall `exec()`">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Syscall <code>exec()</code></strong></p>
</div>
<div class="callout-content">
<p>Permet <strong>transformar un procés fill en un nou programa</strong>. La família de funcions <code>exec</code> substitueix l’espai d’adreces del procés actual amb un nou programa carregat des d’un fitxer executable (<em>normalment en format ELF</em>).</p>
</div>
</div>
</div>
</div>
<div class="callout callout-none no-icon callout-style-simple">
<div class="callout-body">
<div class="callout-content">
<table class="caption-top">
<colgroup>
<col style="width: 24%">
<col style="width: 30%">
<col style="width: 45%">
</colgroup>
<thead>
<tr class="header">
<th>Component</th>
<th>Abans de <code>exec()</code></th>
<th>Després de <code>exec()</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Espai d’Adreces</td>
<td>Mapeig original</td>
<td>Nou mapeig <strong>ELF</strong></td>
</tr>
<tr class="even">
<td>Taula de Fitxers</td>
<td>Heretat</td>
<td>Heretat (excepte <code>FD_CLOEXEC</code>)</td>
</tr>
<tr class="odd">
<td>Registres CPU</td>
<td>Context original</td>
<td><strong>EIP</strong>=punt d’entrada, <strong>ESP</strong>=pila</td>
</tr>
<tr class="even">
<td>Senyals</td>
<td>Handlers personalitzats</td>
<td>Tots restablerts a <code>SIG_DFL</code></td>
</tr>
<tr class="odd">
<td>Memòria Compartida</td>
<td><code>MAP_SHARED</code> preservada</td>
<td><code>MAP_PRIVATE</code> eliminada</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div><div class="column" style="width:35%;">
<div class="cell" data-reveal="true" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<pre class="mermaid mermaid-js">sequenceDiagram
    participant P as Original
    participant K as Kernel
    participant N as Nou

    P-&gt;&gt;K: execve("/bin/ls", ["ls","-l"], envp)
    activate K

    K-&gt;&gt;K: Valida ELF (e_ident, permissions)
    K-&gt;&gt;K: flush_old_exec()
    K-&gt;&gt;K: free_pgtables()
    K-&gt;&gt;K: load_elf_binary()

    Note over P,N: El PID no canvia: és el mateix procés a nivell de nucli

    Note over K,N: Crear Nou Context
    K-&gt;&gt;N: Map .text (RX)
    K-&gt;&gt;N: Map .data/.bss (RW)
    K-&gt;&gt;N: setup_arg_pages(argv, envp) ⟶ stack
    K-&gt;&gt;N: setup_brk() ⟶ heap
    K-&gt;&gt;N: start_thread(entry_point) &lt;br&gt; PC/IP ← entry point of the ELF binary

    deactivate K

    Note over N: Nova execució de codi
    N--&gt;&gt;K: Syscalls Futures
    K--&gt;&gt;N: Returna

    Note right of P: Els espai d'adreces original &lt;br&gt; s'ha destruït &lt;br&gt; `task_struct` és el mateix &lt;br&gt; però amb el nou codi carregat
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div></div>
</section>
<section id="familia-exec" class="slide level2 smaller">
<h2>Familia <code>exec()</code></h2>
<div class="columns">
<div class="column" style="width:40%;">
<p><img data-src="../figures/slides/03-create/env.png"></p>
<div title="Valors de retorn">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Valors de retorn</strong></p>
</div>
<div class="callout-content">
<ul>
<li>Mai retorna en cas d’èxit (<em>substitueix completament el procés</em>).</li>
<li>Retorna -1 només en cas d’error (<em>s’estableix <code>errno</code></em>).</li>
</ul>
</div>
</div>
</div>
</div>
</div><div class="column" style="width:60%;">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb22-1"><a aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb22-2"><a aria-hidden="true" tabindex="-1"></a><span class="co">// Variants with argument list (variable arguments)</span></span>
<span id="cb22-3"><a aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> execl<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>path<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>arg0<span class="op">,</span> <span class="op">...,</span> NULL<span class="op">);</span>                </span>
<span id="cb22-4"><a aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> execlp<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>file<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>arg0<span class="op">,</span> <span class="op">...,</span> NULL<span class="op">);</span>                  </span>
<span id="cb22-5"><a aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> execle<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>path<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>arg0<span class="op">,</span> <span class="op">...,</span> NULL<span class="op">,</span> </span>
<span id="cb22-6"><a aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span><span class="dt">const</span> envp<span class="op">[]);</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb23-1"><a aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb23-2"><a aria-hidden="true" tabindex="-1"></a><span class="co">// Variants with argument vector (array)</span></span>
<span id="cb23-3"><a aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> execv<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>path<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span><span class="dt">const</span> argv<span class="op">[]);</span>                         </span>
<span id="cb23-4"><a aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> execvp<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>file<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span><span class="dt">const</span> argv<span class="op">[]);</span>                       </span>
<span id="cb23-5"><a aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> execve<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>path<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span><span class="dt">const</span> argv<span class="op">[],</span></span>
<span id="cb23-6"><a aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span><span class="dt">const</span> envp<span class="op">[]);</span>             </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="callout callout-none no-icon callout-style-simple">
<div class="callout-body">
<div class="callout-content">
<ul>
<li><code>execve()</code> és la crida al sistema bàsica (<em>les altres són embolcalls de glibc</em>).</li>
<li>Gestiona correctament SUID/SGID.</li>
</ul>
</div>
</div>
</div>
</div></div>
</section>
<section id="exemple-ls--la" class="slide level2 smaller">
<h2>Exemple: <code>ls -la</code></h2>
<div class="columns">
<div class="column" style="width:50%;">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb24-1"><a aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb24-2"><a aria-hidden="true" tabindex="-1"></a>    pid_t pid <span class="op">=</span> fork<span class="op">();</span></span>
<span id="cb24-3"><a aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>pid <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span> </span>
<span id="cb24-4"><a aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span><span class="st">"fork"</span><span class="op">);</span></span>
<span id="cb24-5"><a aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb24-6"><a aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-7"><a aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>pid <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span> </span>
<span id="cb24-8"><a aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> <span class="op">*</span>args<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="st">"ls"</span><span class="op">,</span> <span class="st">"-la"</span><span class="op">,</span> NULL<span class="op">};</span></span>
<span id="cb24-9"><a aria-hidden="true" tabindex="-1"></a>        execv<span class="op">(</span><span class="st">"/bin/ls"</span><span class="op">,</span> args<span class="op">);</span></span>
<span id="cb24-10"><a aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span><span class="st">"execv fallat"</span><span class="op">);</span> </span>
<span id="cb24-11"><a aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb24-12"><a aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> </span>
<span id="cb24-13"><a aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="op">{</span> </span>
<span id="cb24-14"><a aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> status<span class="op">;</span></span>
<span id="cb24-15"><a aria-hidden="true" tabindex="-1"></a>        pid_t w <span class="op">=</span> waitpid<span class="op">(</span>pid<span class="op">,</span> </span>
<span id="cb24-16"><a aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span>status<span class="op">,</span> WUNTRACED<span class="op">);</span></span>
<span id="cb24-17"><a aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-18"><a aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb24-19"><a aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a aria-hidden="true" tabindex="-1"></a><span class="fu">gcc</span> ex7.c <span class="at">-o</span> ex7</span>
<span id="cb25-2"><a aria-hidden="true" tabindex="-1"></a><span class="ex">./ex7</span></span>
<span id="cb25-3"><a aria-hidden="true" tabindex="-1"></a><span class="ex">total</span> 24</span>
<span id="cb25-4"><a aria-hidden="true" tabindex="-1"></a><span class="ex">drwxr-xr-x</span>  2 user user 4096 Feb 20 10:00 .</span>
<span id="cb25-5"><a aria-hidden="true" tabindex="-1"></a><span class="ex">drwxr-xr-x</span> 10 user user 4096 Feb 20 09:58 .. </span>
<span id="cb25-6"><a aria-hidden="true" tabindex="-1"></a><span class="ex">-rwxr-xr-x</span> 1 user user 70512 Feb 20 14:57 ex7</span>
<span id="cb25-7"><a aria-hidden="true" tabindex="-1"></a><span class="ex">-rw-r--r--</span> 1 user user   107 Feb 20 13:23 ex7.c</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div><div class="column" style="width:50%;">
<div class="cell" data-reveal="true" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<pre class="mermaid mermaid-js">sequenceDiagram
    box rgb(240,240,240) Parent Process
    participant P
    end
    
    box rgb(240,240,240) Kernel
    participant K
    end
    
    box rgb(240,240,240) Child Process
    participant F
    end

    P-&gt;&gt;K: Calls `fork()`
    activate K
    K--&gt;&gt;F: Crea una nova còpia del procés (Fill, PID Y)&lt;br&gt; amb memòria idèntica (CoW)
    K--&gt;&gt;P: Retorna PID Y al Pare
    deactivate K
    
    par Execució Concurrent
        F-&gt;&gt;K: Crida `execv("/bin/ls", ["ls","-la"], NULL)`
        
        activate K
        K-&gt;&gt;K: Valida `/bin/ls` (permissos, format)
        K-&gt;&gt;K: Esborra tota la memòria del Fill (F)**
        K-&gt;&gt;K: Carrega `ls` a la memòria del Fill**&lt;br&gt;  (codi, dades, nova pila)
        K-&gt;&gt;K: Reconfigura els registres de la CPU i el PC/IP&lt;br&gt;  al punt d'entrada de `ls`
        deactivate K

        Note over K,F: Codi original Fill (PID Y) &lt;br&gt; ha estat reemplaçat per `/bin/ls`.

        activate F
        F-&gt;&gt;F: Executa el programa `/bin/ls -la`&lt;br&gt;Genera la llista a `stdout`.
        F-&gt;&gt;K: `exit(0)` (Finalitza `/bin/ls`)
        deactivate F
        
        activate P
        P-&gt;&gt;K: `waitpid(PID Y, &amp;status, WUNTRACED)`
        deactivate P
    end

    K--&gt;&gt;P: Notifica al Pare que el fill (ara `ls`) ha acabat.
    activate P
    P-&gt;&gt;K: `exit(0)` (Finalitza el Pare)
    deactivate P
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div></div>
</section>
<section id="exercicis-proposats" class="slide level2 smaller">
<h2>Exercicis proposats</h2>
<ul>
<li class="fragment"><a href="../activities/unit02/01-create.html">Exercici de Creació de Processos</a></li>
</ul>
</section>
<section id="això-és-tot-per-avui" class="slide level2 smaller">
<h2>Això és tot per avui</h2>
<div class="columns">
<div class="column" style="width:60%;">
<h4 id="take-home-message">TAKE HOME MESSAGE</h4>
<p>La creació i gestió de processos és fonamental en els sistemes operatius. Hem explorat com <code>fork()</code> crea nous processos, com <code>exec()</code> permet la transformació de processos, i com <code>wait()</code> i <code>waitpid()</code> gestionen la sincronització entre pares i fills. A més, hem vist com es gestionen els processos zombies i orfes, i la importància de les macros per interpretar els estats dels processos fills.</p>
</div><div class="column" style="width:40%;">
<p><img data-src="https://static.posters.cz/image/750/posters/looney-tunes-thats-all-folks-i295.jpg"></p>
</div></div>


</section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<p><img src="../figures/corporative/institute.png" class="slide-logo"></p>
<div class="footer footer-default">
<p>Unitat 3 · Sistemes Operatius (SO) <a href="../index.html">🏠</a></p>
</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="../site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="../site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="../site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="../site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="../site_libs/revealjs/plugin/search/search.js"></script>
  <script src="../site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="../site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'fade',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdn.jsdelivr.net/npm/mathjax@2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <script id="quarto-html-after-body" type="application/javascript">
      window.document.addEventListener("DOMContentLoaded", function (event) {
        const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
        tabsets.forEach(function(tabset) {
          const tabby = new Tabby('#' + tabset.id);
        });
        const isCodeAnnotation = (el) => {
          for (const clz of el.classList) {
            if (clz.startsWith('code-annotation-')) {                     
              return true;
            }
          }
          return false;
        }
        const onCopySuccess = function(e) {
          // button target
          const button = e.trigger;
          // don't keep focus
          button.blur();
          // flash "checked"
          button.classList.add('code-copy-button-checked');
          var currentTitle = button.getAttribute("title");
          button.setAttribute("title", "Copied!");
          let tooltip;
          if (window.bootstrap) {
            button.setAttribute("data-bs-toggle", "tooltip");
            button.setAttribute("data-bs-placement", "left");
            button.setAttribute("data-bs-title", "Copied!");
            tooltip = new bootstrap.Tooltip(button, 
              { trigger: "manual", 
                customClass: "code-copy-button-tooltip",
                offset: [0, -8]});
            tooltip.show();    
          }
          setTimeout(function() {
            if (tooltip) {
              tooltip.hide();
              button.removeAttribute("data-bs-title");
              button.removeAttribute("data-bs-toggle");
              button.removeAttribute("data-bs-placement");
            }
            button.setAttribute("title", currentTitle);
            button.classList.remove('code-copy-button-checked');
          }, 1000);
          // clear code selection
          e.clearSelection();
        }
        const getTextToCopy = function(trigger) {
          const outerScaffold = trigger.parentElement.cloneNode(true);
          const codeEl = outerScaffold.querySelector('code');
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
        }
        const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
          text: getTextToCopy
        });
        clipboard.on('success', onCopySuccess);
        if (window.document.getElementById('quarto-embedded-source-code-modal')) {
          const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
            text: getTextToCopy,
            container: window.document.getElementById('quarto-embedded-source-code-modal')
          });
          clipboardModal.on('success', onCopySuccess);
        }
          var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
          var mailtoRegex = new RegExp(/^mailto:/);
            var filterRegex = new RegExp("https:\/\/os-gei-udl-2526-105012\.github\.io\/course\/");
          var isInternal = (href) => {
              return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
          }
          // Inspect non-navigation links and adorn them if external
         var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
          for (var i=0; i<links.length; i++) {
            const link = links[i];
            if (!isInternal(link.href)) {
              // undo the damage that might have been done by quarto-nav.js in the case of
              // links that we want to consider external
              if (link.dataset.originalHref !== undefined) {
                link.href = link.dataset.originalHref;
              }
            }
          }
        function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
          const config = {
            allowHTML: true,
            maxWidth: 500,
            delay: 100,
            arrow: false,
            appendTo: function(el) {
                return el.closest('section.slide') || el.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'light-border',
            placement: 'bottom-start',
          };
          if (contentFn) {
            config.content = contentFn;
          }
          if (onTriggerFn) {
            config.onTrigger = onTriggerFn;
          }
          if (onUntriggerFn) {
            config.onUntrigger = onUntriggerFn;
          }
            config['offset'] = [0,0];
            config['maxWidth'] = 700;
          window.tippy(el, config); 
        }
        const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
        for (var i=0; i<noterefs.length; i++) {
          const ref = noterefs[i];
          tippyHover(ref, function() {
            // use id or data attribute instead here
            let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
            try { href = new URL(href).hash; } catch {}
            const id = href.replace(/^#\/?/, "");
            const note = window.document.getElementById(id);
            if (note) {
              return note.innerHTML;
            } else {
              return "";
            }
          });
        }
        const findCites = (el) => {
          const parentEl = el.parentElement;
          if (parentEl) {
            const cites = parentEl.dataset.cites;
            if (cites) {
              return {
                el,
                cites: cites.split(' ')
              };
            } else {
              return findCites(el.parentElement)
            }
          } else {
            return undefined;
          }
        };
        var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
        for (var i=0; i<bibliorefs.length; i++) {
          const ref = bibliorefs[i];
          const citeInfo = findCites(ref);
          if (citeInfo) {
            tippyHover(citeInfo.el, function() {
              var popup = window.document.createElement('div');
              citeInfo.cites.forEach(function(cite) {
                var citeDiv = window.document.createElement('div');
                citeDiv.classList.add('hanging-indent');
                citeDiv.classList.add('csl-entry');
                var biblioDiv = window.document.getElementById('ref-' + cite);
                if (biblioDiv) {
                  citeDiv.innerHTML = biblioDiv.innerHTML;
                }
                popup.appendChild(citeDiv);
              });
              return popup.innerHTML;
            });
          }
        }
      });
      </script>
    

</body></html>